<!DOCTYPE html>
<head>
<meta charset="utf-8">
<svg width="960" height="800" font-family="sans-serif" font-size="10"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
  <style>
   div {
      position : absolute;
   		 top: 10%;
   		 left: 4%;

    }
    
    .hidden {
        display: none;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
    }
  </style>
  <div>
    <input id="slider" type="range"  min="2016" max="2019" step="1" />
    <span id="week">Year</span>
    </div>
    <p><a href="test.html">Visit our HTML tutorial</a></p>

  
<script>

var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height"),
    innerRadius = 162,
    outerRadius = Math.min(width, height) / 1.43470559232,
    g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");


var xScaleOffset = 0;
var x = d3.scaleBand()
    .range([xScaleOffset, 2 * Math.PI + xScaleOffset])
    .align(0);

var y = d3.scaleLinear()
    .range([innerRadius, outerRadius]);

var z = d3.scaleOrdinal()
    .range(["#40c534", "#68a7ce"]);
 
var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip')


var zClasses = ['Message received', 'Message sent'];

d3.csv("data.csv", function(d, i, columns) {
  d.received = (+d.received);
  d.sent =  (+d.sent);
  return d;
}, function(error, data) {
  if (error) throw error;
	
  var keys = data.columns.slice(1);
  //begin
  updateViz(2018) // for the beginning
  
  function getYearData(data,year){
    result = data.filter(word => word.date.split('-')[0] == year);
  result.columns = ["date", "received", "sent"]
  return result;
    
  }
  
  
	 

  
  // Slider Listner
        d3.select("#slider").on("input", function() {
          updateViz(+this.value);
          console.log(this.value)
        })
  
        
        
 function updateViz(year){
   d3.select('#week').html(+year);
   
   //var gi = g.select("g").selectAll("path").data(getYearData(data,year))
                       
  	//console.log(gi)                  
   //gi.exit().remove();
   
   d3.select("svg").selectAll("g").remove();
   
   drawMap(getYearData(data,year));
}
        
        
function drawMap(data){
  
   svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height"),
    innerRadius = 158,
    outerRadius = Math.min(width, height) / 1.9160064,
    g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    var meanMessages = d3.mean(data, function(d) { return d3.sum(keys, function(key) {  return d[key]; }); })

  //console.log(meanMessages)
  x.domain(data.map(function(d) { return d.date; }));
  y.domain([0, d3.max(data, function(d) { return (d.received + d.sent); })]);
  z.domain(data.columns.slice(1));

  // Messages
  msg = g.append('g')
      .selectAll("g")
    .data(d3.stack().keys(data.columns.slice(1))(data))
   
    msg.enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("path")
    .data(function(d) { console.log(d);return d; })
    
    .enter().append("path")
    	
      .attr("d", d3.arc()
          .innerRadius(function(d) { return y(d[0]); })
          .outerRadius(function(d) { return y(d[1]); })
          .startAngle(function(d) { return x(d.data.date); })
          .endAngle(function(d) { return x(d.data.date) + x.bandwidth(); })
          .padAngle(0.0116)
          .padRadius(innerRadius))
			    .on('mousemove', function(d) {
            			
                    var mouse = d3.mouse(svg.node()).map(function(d) {
                      
                      return parseInt(d);
                    });
            				  
                    tool = tooltip.classed('hidden', false)
                        .attr('style', 'left:' + (mouse[0] + 15) +
                                'px; top:' + (mouse[1] - 35) + 'px')
                    tool.html(d.data.date+"<br/>" +"Received : "+d.data.received
                             +"<br/>" +"Sent : "+d.data.sent
                             )
           					
                    
                })
    			.on('mouseout', function() {
      // sleep time expects milliseconds
    function sleep (time) {
      return new Promise((resolve) => setTimeout(resolve, time));
    }

    // Usage!
    sleep(2000).then(() => {
			tooltip.classed('hidden', true);    });

      })
  //yAxis and Mean

  var yAxis = g.append("g")
      .attr("text-anchor", "middle");

  var yTicksValues = d3.ticks(0, 60, 3);


  // Mean value line
  var yMeanTick = yAxis
    .append("g")
    .datum([meanMessages]);

  yMeanTick.append("circle")
      .attr("fill", "none")
      .attr("stroke", "#C0625E")
      .attr("stroke-dasharray", "5 3")
      .attr("r", y);

  var yTick = yAxis
    .selectAll("g")
    .data(yTicksValues)
    .enter().append("g");

  yTick.append("circle")
      .attr("fill", "none")
      .attr("stroke", "#ccdcea")
      .attr("r", y);

  yTick.append("text")
      .attr("y", function(d) { return -y(d); })
      .attr("dy", "0.35em")
      .attr("fill", "none")
      .attr("stroke", "#fff")
      .attr("stroke-width", 5)
      .text(y.tickFormat(5, "s"));

  yTick.append("text")
      .attr("y", function(d) { return -y(d); })
      .attr("dy", "0.35em")
      .text(y.tickFormat(5, "s"));

  yAxis.append("text")
      .attr("y", function(d) { return -y(yTicksValues.pop()); })
      .attr("dy", "-2em")
      .text("label");

  // Labels for xAxis

  var label = g.append("g")
    .selectAll("g")
    .data(data)
    .enter().append("g")
      .attr("text-anchor", "middle")
      .attr("transform", function(d) { return "rotate(" + ((x(d.date) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")translate(" + innerRadius + ",0)"; });

  label.append("line")
      .attr("x2", function(d) { 
    
    return d.date.split('-')[2] == 1 ? -7 : -4 })
      .attr("stroke", "#000");

  label.append("text")
      .attr("transform", function(d) { return (x(d.date) + x.bandwidth() / 2 + Math.PI / 2) % (2 * Math.PI) < Math.PI ? "rotate(90)translate(0,16)" : "rotate(-90)translate(0,-9)"; })
      .text(function(d) {
     
    tab = ["January","February","March","April","May","June","July", "August","September","October","November","December"]
    month = d.date.split('-')[1]
    day = d.date.split('-')[2]
    label = tab[month-1]
    //console.log(label)
    //console.log(d.date)
        var xlabel = day == 1 ? label : '';
        return xlabel; });
 
// Legend
  var legend = g.append("g")
    .selectAll("g")
    .data(zClasses)
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(-50," + (i - (zClasses.length - 1) / 2) * 25+ ")"; });

  legend.append("circle")
      .attr("r", 8)
      .attr("fill", z);

  legend.append("text")
      .attr("x", 15)
      .attr("y", 0)
      .attr("dy", "0.35em")
      .text(function(d) { return d; });
  
}


});

</script>
</body>